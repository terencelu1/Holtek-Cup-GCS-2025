# 數據格式文檔總覽

本專案的數據格式定義文檔集合

**版本**: v1.0  
**最後更新**: 2025-11-21

---

## 📚 文檔列表

### 1. 📖 [數據格式定義.md](./數據格式定義.md) - 核心協議規範
**用途**: 完整的數據格式定義文檔（最重要）  
**內容**:
- 通用數據包格式（0xFF 起始標識）
- 所有數據類型ID定義（0x0100-0x12FF）
- 詳細的數據結構定義（C struct 格式）
- CRC16 校驗算法
- 協議特性與注意事項
- 數據包範例

**適合對象**: 協議開發者、系統架構師、嵌入式工程師

**關鍵章節**:
- 數據包通用格式（第 2 章）
- 載具→中控數據類型（第 3 章）
- 中控→載具數據類型（第 4 章）
- 協議特性（第 7 章）

---

### 2. 💻 [數據格式實現參考.md](./數據格式實現參考.md) - 程式實現指南
**用途**: 提供 Python、C、Arduino 的實現範例  
**內容**:
- Python 完整實現（編碼/解碼類）
- C 語言實現（嵌入式適用）
- Arduino/ESP32 範例
- 使用範例與測試程式碼
- 性能優化建議

**適合對象**: 程式開發者、嵌入式工程師

**關鍵章節**:
- Python 實現（第 1 章）
- C 語言實現（第 2 章）
- Arduino 範例（第 3 章）
- 性能考量（第 4 章）

---

### 3. 📋 [數據類型速查表.md](./數據類型速查表.md) - 快速參考手冊
**用途**: 快速查找數據類型定義和參數說明  
**內容**:
- 所有數據類型ID速查表
- 常用命令組合範例
- 飛行模式、狀態代碼對照表
- 數據轉換公式
- UI 顏色編碼建議
- 使用提示

**適合對象**: 所有開發者（日常開發必備）

**關鍵章節**:
- 快速索引（第 1 章）
- 完整數據類型列表（第 2 章）
- 常用命令組合（第 3 章）
- 數據欄位說明（第 4 章）

---

### 4. 🔄 [MAVLink轉換映射.md](./MAVLink轉換映射.md) - 協議轉換指南
**用途**: MAVLink 與自定義協議之間的雙向轉換  
**內容**:
- 轉換架構說明
- MAVLink → 自定義協議轉換範例
- 自定義協議 → MAVLink 轉換範例
- 完整轉換器類別實現
- 轉換性能分析

**適合對象**: 載具端開發者、協議轉換器開發者

**關鍵章節**:
- 轉換架構（第 1 章）
- 載具→中控轉換（第 2 章）
- 中控→載具轉換（第 3 章）
- 轉換器實現（第 4 章）

---

## 🎯 使用指南

### 情境1: 我是新加入的開發者，從哪裡開始？

**推薦閱讀順序**:
1. 先看 **數據類型速查表.md** - 快速了解整體架構
2. 再看 **數據格式定義.md** - 深入理解協議細節
3. 根據開發語言選擇 **數據格式實現參考.md** 相關章節
4. 如果涉及 MAVLink，查看 **MAVLink轉換映射.md**

---

### 情境2: 我要實現中控系統（Python/Web）

**必讀文檔**:
1. **數據格式定義.md** - 第 3、4 章（數據類型ID）
2. **數據格式實現參考.md** - 第 1 章（Python 實現）
3. **數據類型速查表.md** - 第 3 章（常用命令組合）

**關鍵功能實現**:
```python
# 1. 實現數據包編碼/解碼
from packet_protocol import PacketCodec, Heartbeat, GPS

# 2. 接收載具數據
source, target, data_type, payload = PacketCodec.decode(received_packet)
if data_type == DataType.GPS:
    gps = GPS.decode(payload)
    print(f"位置: {gps.latitude}, {gps.longitude}")

# 3. 發送控制命令
arm_cmd = ArmCommand(timestamp=..., arm=True, force=False)
packet = PacketCodec.encode(DeviceID.GCS, DeviceID.UAV, 
                           DataType.ARM_COMMAND, arm_cmd.encode())
send_to_vehicle(packet)
```

---

### 情境3: 我要實現載具端（樹莓派 Python）

**必讀文檔**:
1. **MAVLink轉換映射.md** - 全部（核心功能）
2. **數據格式實現參考.md** - 第 1 章（Python 實現）
3. **數據格式定義.md** - 第 2 章（包格式）

**關鍵功能實現**:
```python
from pymavlink import mavlink
from protocol_converter import ProtocolConverter

# 1. 初始化轉換器
master = mavlink.mavlink_connection('COM6', baud=9600)
converter = ProtocolConverter(master)

# 2. MAVLink → 自定義協議
while True:
    msg = master.recv_match(blocking=False)
    if msg:
        result = converter.mavlink_to_custom(msg)
        if result:
            data_type, custom_data = result
            # 編碼並發送給中控
            packet = PacketCodec.encode(DeviceID.UAV, DeviceID.GCS,
                                       data_type, custom_data.encode())
            send_to_gcs(packet)

# 3. 自定義協議 → MAVLink
received_packet = receive_from_gcs()
source, target, data_type, payload = PacketCodec.decode(received_packet)
converter.custom_to_mavlink(data_type, payload)
```

---

### 情境4: 我要實現載具端（Arduino/ESP32 C++）

**必讀文檔**:
1. **數據格式實現參考.md** - 第 2、3 章（C/Arduino）
2. **數據格式定義.md** - 第 2 章（包格式）
3. **數據類型速查表.md** - 第 2 章（數據類型列表）

**關鍵功能實現**:
```cpp
#include "packet_protocol.h"

void setup() {
    Serial.begin(115200);      // USB調試
    Serial1.begin(9600);       // 與飛控通訊
    Serial2.begin(115200);     // 與中控通訊（自定義協議）
}

void loop() {
    // 1. 從飛控接收 MAVLink，轉換並發送給中控
    if (Serial1.available()) {
        // 讀取 MAVLink 訊息
        // 轉換為自定義協議
        // 通過 Serial2 發送給中控
    }
    
    // 2. 從中控接收命令，轉換並發送給飛控
    if (Serial2.available()) {
        // 讀取自定義協議數據包
        uint8_t buffer[512];
        // ... 解碼並轉換為 MAVLink
        // 通過 Serial1 發送給飛控
    }
}
```

---

### 情境5: 我要實現UI界面

**必讀文檔**:
1. **數據類型速查表.md** - 第 4、5、6 章（欄位說明、轉換、顏色）
2. **數據格式定義.md** - 第 3 章（載具數據類型）

**關鍵功能實現**:
```javascript
// 1. 接收並解析數據
async function fetchVehicleData() {
    const response = await fetch('/api/vehicle/UAV1/telemetry');
    const data = await response.json();
    
    // 顯示姿態
    updateAttitudeIndicator(data.attitude.rollDeg, 
                           data.attitude.pitchDeg);
    
    // 顯示GPS
    updateMapMarker(data.gps.latitude, data.gps.longitude);
    
    // 顯示電池（根據電量改變顏色）
    const batteryColor = getBatteryColor(data.battery.percent);
    updateBatteryDisplay(data.battery.percent, batteryColor);
}

function getBatteryColor(percent) {
    if (percent >= 80) return '#00FF00';      // 綠色
    if (percent >= 50) return '#0000FF';      // 藍色
    if (percent >= 20) return '#FFFF00';      // 黃色
    return '#FF0000';                          // 紅色
}
```

---

## 📊 文檔對照表

| 需求 | 主要文檔 | 輔助文檔 |
|------|---------|---------|
| 了解協議架構 | 數據格式定義.md | 數據類型速查表.md |
| Python 開發 | 數據格式實現參考.md (§1) | 數據格式定義.md |
| C/Arduino 開發 | 數據格式實現參考.md (§2-3) | 數據類型速查表.md |
| MAVLink 轉換 | MAVLink轉換映射.md | 數據格式實現參考.md |
| 快速查找數據類型 | 數據類型速查表.md (§2) | - |
| 查找命令組合 | 數據類型速查表.md (§3) | - |
| UI 開發 | 數據類型速查表.md (§4-6) | 數據格式定義.md (§3) |
| 調試與測試 | 數據格式實現參考.md (§4) | 數據格式定義.md (§8) |

---

## 🔧 開發工具建議

### Python 開發
```bash
# 安裝依賴
pip install pymavlink pyserial

# 測試腳本
python test_protocol.py
```

### C 開發
```bash
# 編譯測試
gcc -o test_protocol packet_protocol.c example_usage.c
./test_protocol
```

### Arduino 開發
```
Arduino IDE 或 PlatformIO
- 複製 packet_protocol.h/c 到專案目錄
- 包含必要的庫: <Arduino.h>
```

---

## 📝 開發檢查清單

### 載具端實現
- [ ] 實現 MAVLink 訊息接收
- [ ] 實現 MAVLink → 自定義協議轉換
- [ ] 實現自定義協議編碼器
- [ ] 實現通訊發送（串口/網路）
- [ ] 實現自定義協議解碼器
- [ ] 實現自定義協議 → MAVLink 轉換
- [ ] 測試心跳包發送（1 Hz）
- [ ] 測試姿態數據發送（20 Hz）
- [ ] 測試命令接收與執行
- [ ] 測試 CRC 校驗
- [ ] 測試錯誤處理

### 中控端實現
- [ ] 實現自定義協議解碼器
- [ ] 實現數據接收與解析
- [ ] 實現數據存儲與分發
- [ ] 實現自定義協議編碼器
- [ ] 實現控制命令發送
- [ ] 實現心跳包監控
- [ ] 實現連線狀態檢測
- [ ] 實現 UI 數據更新
- [ ] 測試多載具支援
- [ ] 測試高頻數據處理
- [ ] 測試命令確認機制

---

## 🐛 常見問題

### Q1: CRC 校驗總是失敗？
**A**: 檢查以下項目：
1. 確認字節序（Little Endian）
2. 確認 CRC 計算範圍（從版本到數據載荷）
3. 確認使用 CRC16-CCITT 算法（多項式 0x1021）
4. 查看 [數據格式定義.md § 協議特性] 的 CRC 計算範例

### Q2: 數據包解析錯誤？
**A**: 檢查：
1. 起始標識是否為 0xFF
2. 結束標識是否為 0xFE
3. 數據長度欄位是否正確
4. 是否有緩衝區溢出
5. 查看 [數據格式實現參考.md § Python實現] 的解碼範例

### Q3: 如何處理大型數據包（影像）？
**A**: 建議：
1. 實作數據包分片機制（見 [數據格式定義.md § 大數據包處理]）
2. 調整影像壓縮品質
3. 降低影像發送頻率
4. 使用獨立的影像傳輸通道

### Q4: MAVLink 模式如何對應？
**A**: 查看：
- [MAVLink轉換映射.md § 模式切換] - 詳細的模式對應表
- [數據類型速查表.md § 飛行模式代碼] - 快速參考

### Q5: 如何實現多載具？
**A**: 
1. 使用不同的設備ID（0x02=UAV, 0x03=UGV）
2. 中控維護多個載具狀態字典
3. 實現廣播機制（目標ID=0xFF）用於位置共享
4. 查看 [數據類型速查表.md § 場景4: UAV跟隨UGV]

---

## 📈 協議版本規劃

### v1.0 (當前)
- ✅ 基礎數據類型定義
- ✅ CRC16 校驗
- ✅ 心跳包機制
- ✅ 基本控制命令
- ✅ 任務規劃命令

### v1.1 (計劃中)
- ⏳ 數據包分片機制
- ⏳ 數據壓縮支援
- ⏳ 加密選項
- ⏳ 更多感測器數據類型

### v2.0 (未來)
- 📋 協議協商機制
- 📋 動態頻率調整
- 📋 Qos 服務質量
- 📋 多層優先級隊列

---

## 🔗 外部資源

- [MAVLink 官方文檔](https://mavlink.io/)
- [ArduPilot 開發文檔](https://ardupilot.org/dev/)
- [CRC 計算器](https://crccalc.com/)

---

## 📞 支援與反饋

如有問題或建議：
1. 查看本文檔的常見問題章節
2. 查閱相關技術文檔
3. 通過 GitHub Issues 提問
4. 提交 Pull Request 改進文檔

---

**文檔維護**: 專案團隊  
**最後更新**: 2025-11-21  
**協議版本**: v1.0

